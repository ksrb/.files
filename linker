#!/usr/bin/env zsh

# cd to the directory that script is being executed and set configs_dir to directory
configs_dir=$( cd "$(dirname "$0")" ; pwd )
target="$configs_dir/.."
ignores_global=(README.md)

shared_configs_dir="$configs_dir/shared"
shared_config_ignores+=(
  $ignores_global
)

mac_configs_dir="$configs_dir/mac"
mac_configs_ignores+=(
  $ignores_global
  Karabiner
  defaults.sh
  override.sh
)

windows_configs_dir="$configs_dir/windows"
window_configs_ignores+=(
  $ignores_global
)

setEnv(){
  case "$(uname -s)" in
    CYGWIN*)
      export CYGWIN=winsymlinks:native
  esac
}

setEnv

ignored() {
  local elements="$2"
  # For each element
  # Note: Zsh specific expansion syntax
  # See http://stackoverflow.com/a/14693738
  for e in ${(P)${elements}[@]}; do
    # If the element matches the 1st arg
    if [[ "$e" == "$1" ]] then;
      return 1; #true, ignored
    fi
  done
  return 0 #false, not ignored
}

linkDotFiles(){
  local mode="$1"
  local configs_dir="$2"
  local ignores_local="$3"

  # For each file in the configs_dir
  for file in $(ls "${configs_dir}"); do
    # Check if the file is in list of ignores
    ignored "$file" "$ignores_local"

    # If the file is ignored
    # Note: ($? gets the exit status of the previous command)
    if [ $? -eq 1 ]; then
      # Skip it
      continue
    fi

    # If the link exits
    if [[ -L "$target/.$file" ]]; then
      if [ "$mode" = "clean" ]; then
        printf "$target/.$file removed\n"
      fi
      # Remove it
      rm "$target/.$file"
    fi

    if [ "$mode" = "link" ]; then
      printf "$configs_dir/$file => $target/.$file\n"
      # Link each file in the configs_dir to a '.' target file
      ln -s "$configs_dir/$file" "$target/.$file"
    fi
  done
}

linkFile(){
  local mode="$1"
  local src="$2"
  local dest="$3"

  if [[ -L "$dest" ]]; then
    if [ "$mode" = "clean" ]; then
      dest="$2"
    fi
    rm "$dest"
    if [ "$mode" = "clean" ]; then
      printf "$dest removed\n"
    fi
  fi

  if [ "$mode" = "link" ]; then
    ln -s "$src" "$dest"
    printf "$src => $dest\n"
  fi
}

linkDotFilesForOs() {
  echo "Link OS independent dotfiles"
  linkSharedFiles
  case "$(uname -s)" in
    "Darwin")
      echo "Darwin based environment detected"
      linkMacFiles;;
    "CYGWIN*")
      echo "Cygwin based environment detected"
      linkWindowFiles;;
  esac
}

setIntelliJConfig() {
  case "$(uname -s)" in
    "Darwin")
      echo idea.config.path=~/.IntelliJIdea/config  >> "/Applications/IntelliJ IDEA.app/Contents/bin/idea.properties";;
    "CYGWIN*")
      echo idea.config.path=~/.IntelliJIdea/config  >> "C:/Program Files (x86)/JetBrains/IntelliJ IDEA 2016.1/bin/idea.properties";;
  esac
}

linkSharedFiles() {
  linkDotFiles "link" "$shared_configs_dir" "shared_config_ignores"
}

linkWindowFiles() {
  linkDotFiles "link" "$windows_configs_dir" "ignores_global"
}

linkMacFiles() {
  linkDotFiles "link" "$mac_configs_dir" "mac_configs_ignores"
  linkFile "link" "$mac_configs_dir/Karabiner/private.xml" "$target/Library/Application Support/Karabiner/private.xml"
}

linkNVim() {
  linkFile "link" "$shared_configs_dir/vimrc" "$target/.config/nvim/init.vim"
  linkFile "link" "$shared_configs_dir/vimrc.bundles" "$target/.config/nvim/vimrc.bundles"
  linkFile "link" "$mac_configs_dir/vimrc.bundles.oss" "$target/.config/nvim/vimrc.bundles.oss"
}

clean(){
  linkDotFiles "clean" "$shared_configs_dir"
  case "$(uname -s)" in
    "Darwin")
      linkDotFiles "clean" "$mac_configs_dir" "mac_configs_ignores";;
    "CYGWIN*")
      linkDotFiles "clean" "$windows_configs_dir" "window_configs_ignores";;
  esac
}

help(){
cat <<-EOF
  Usage: linker [COMMAND]
  Commands:
  ln      Link dotfiles based on OS, will replace existing symlinks
  clean   clean symlinks based on OS

  Additional Commands:
  ls      Link only shared dotfiles
  lm      Link only Mac dotfiles
  lw      Link only Windows dotfiles
  si      Set IntelliJ config directory to ~/.IntelliJIdea based on OS
EOF
}

process(){
  case "$1" in
    "ln")
      linkDotFilesForOs;;
    "si")
      setIntelliJConfig;;
    "ls")
      linkSharedFiles;;
    "lm")
      linkMacFiles;;
    "lw")
      linkWindowFiles;;
    "clean")
      clean;;
    "help")
      help;;
    *)
      echo "Not a valid command"
      help;;
  esac
}

process "$@"
